#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <signal.h>
#include <wiringPi.h>
#include <wiringSerial.h>
#include <errno.h>
#include <pthread.h>


#define TRIG 5   //GPIO 24
#define ECHO 6   //GPIO 25
#define TRIG2 21   //GPIO 5
#define ECHO2 22   //GPIO 6


int stexec = 0;
double distancia1 = 0.0;
double distancia2 =0.0;

void setup() {
       wiringPiSetup();
       pinMode(TRIG, OUTPUT);
       pinMode(ECHO, INPUT);
       pinMode(TRIG2, OUTPUT);
       pinMode(ECHO2, INPUT);
}


void* ultr1(void* arg) {
        //Manda pulso trig
        digitalWrite(TRIG, HIGH);
        delay(0.01);      //delayMicroseconds(20);usleep (20)
        digitalWrite(TRIG, LOW);

        while(digitalRead(ECHO) == 0); //Espera echo ficar em nível alto
        double startTime = micros(); 	//marcação de tempo
        while(digitalRead(ECHO) == 1); //espera echo acabar
        double endTime = micros(); //tempo do fim do pulso - tempo inicial
        double travelTime = endTime - startTime;

        //Conversão em cm
        distancia1 = (travelTime/58.0); 
	delay(1000);

  
        printf("Distancia1: %.3lf cm\n", distancia1);
        return NULL;
} //thread sensor ultrassom 1

void* ultr2(void* arg) {
        //Manda pulso trig
        digitalWrite(TRIG2, HIGH);
        delay(0.01);      //delayMicroseconds(20);usleep (20)
        digitalWrite(TRIG2, LOW);

        while(digitalRead(ECHO2) == 0); //Espera echo ficar em nível alto
        double startTime = micros(); 	//marcação de tempo
        while(digitalRead(ECHO2) == 1); //espera echo acabar
        double endTime = micros(); //tempo do fim do pulso - tempo inicial
        double travelTime = endTime - startTime;

        //Conversão em cm
        distancia2 = (travelTime/58.0); 
	delay(1000);
        printf("Distancia2: %.3lf cm\n", distancia2);
        return NULL;
} //thread sensor ultrassom 2

void picture(){
	int fp, i=0;
	char ch;
	char det[35];
	//char buffer_ent[100];
	//char buffer_sai[100];

	system("vcgencmd get_camera >> camanalyser.txt");  

	fp = open("camanalyser.txt", O_RDONLY);

	while(read(fp,&ch,1) > 0){
  		  det[i] = ch;
		     i++;
	}
	close(fp);
	if (det[21] == '0') { //posição da string que diz se a camera está conectada
		printf("A camera não está conectada\n Falha em abrir\n");
		system("curl -s -X POST https://api.telegram.org/bot106/sendMessage -d chat_id=705-d text='A stream falhou em ser executada'");
		system("sudo rm camanalyser.txt"); //remove arquivo de análise do status da câmera
		exit(-1);

	}
        system("sudo rm camanalyser.txt"); //remove arquivo de análise do status da câmera
	system("raspistill -vf -hf -o cam2.jpg"); //gira a foto
	system("raspistill -o cam.jpg");  //tira foto padrao

} //fotos


void ctrl_c(int sig)
{
     	system("sudo rm -r /home/pi/Desktop/projeto/cam.jpg");
     	printf("Cancelando os processos\n");
 	exit(-1);
}

int main(int argc, char *argv[])
{
	
	setup();  	//definindo as portas wiringpi
    	pthread_t thr_1, thr_2;
    	signal(SIGINT, ctrl_c);

	while(1)
	{
		usleep(50000);
		pthread_create(&thr_1, NULL, &ultr1, NULL);
		pthread_create(&thr_2, NULL, &ultr2, NULL);
		pthread_join(thr_1, NULL);
		pthread_join(thr_2, NULL);
		
		if((distancia1 > 1 && distancia1 < 30 ) | (distancia2 > 1 && distancia2 < 30))
		{
			usleep(50000);
			picture();  //tira a foto
			stexec = 1;
		}
		
		if (stexec == 1)
		{
				
			
			//system("python3 telbot.py");
			//usleep(300000);
			system("./tg.sh Pi_Monitor /home/pi/Desktop/projeto/cam.jpg"); //manda por telegram cli
                        usleep(50000000); //tempo de upload da foto telegramcli
			//system("sudo rm -r /home/pi/Desktop/projeto/cam.jpg");
		}
	
	stexec = 0;
	}
    return 0;
}
