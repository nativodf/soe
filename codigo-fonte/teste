#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <signal.h>
#include <wiringPi.h>
#include <wiringSerial.h>
#include <errno.h>
#include <pthread.h>

#include <tof.h>

#define TRIG 5   //GPIO 24
#define ECHO 6   //GPIO 25
#define TRIG2 21   //GPIO 5
#define ECHO2 22   //GPIO 6


int stexec = 0;
double dist1 = 0.0;
double dist2 =0.0;

void setup() {
       wiringPiSetup();
       pinMode(TRIG, OUTPUT);
       pinMode(ECHO, INPUT);
       pinMode(TRIG2, OUTPUT);
       pinMode(ECHO2, INPUT);
}


void* ultr1(void* arg) {
        //Manda pulso trig
        digitalWrite(TRIG, HIGH);
        delay(0.01);      //delayMicroseconds(20);usleep (20)
        digitalWrite(TRIG, LOW);

        while(digitalRead(ECHO) == 0); //Espera echo ficar em nível alto
        double startTime = micros(); 	//marcação de tempo
        while(digitalRead(ECHO) == 1); //espera echo acabar
        double endTime = micros(); //tempo do fim do pulso - tempo inicial
        double travelTime = endTime - startTime;

        //Conversão em cm
        dist1 = (travelTime/58.0); //

        //printf("Distance: %.5lf us\n", travelTime);
        printf("Dist1: %.3lf cm\n", dist1);
        return NULL;
} //thread sensor ultrassom 1

void* ultr2(void* arg) {
        //Manda pulso trig
        digitalWrite(TRIG2, HIGH);
        delay(0.01);      //delayMicroseconds(20);usleep (20)
        digitalWrite(TRIG2, LOW);

        while(digitalRead(ECHO2) == 0); 
        double startTime = micros(); 	//marcação de tempo
        while(digitalRead(ECHO2) == 1); //espera echo acabar
        double endTime = micros(); 
        double travelTime = endTime - startTime;

        //Conversão em cm
        dist2 = (travelTime/58.0); //

        //printf("Distance: %.5lf us\n", travelTime);
        printf("Dist2: %.3lf cm\n", dist2);
        return NULL;
} //thread sensor ultrassom 2

void picture(){
	int fp, i=0;
	char ch;
	char det[35];
	char buffer_ent[100];
	char buffer_sai[100];


	system("vcgencmd get_camera >> camanalyser.txt");  

	fp = open("camanalyser.txt", O_RDONLY);

	while(read(fp,&ch,1) > 0){
  		  det[i] = ch;
		     i++;
	}
	close(fp);
	if (det[21] == '0') { //posição da string que diz se a camera está conectada
		printf("A camera não está conectada\n Falha em abrir stream\n");
		system("curl -s -X POST https://api.telegram.org/bot106/sendMessage -d chat_id=705-d text='A stream falhou em ser executada'");
		system("sudo rm camanalyser.txt"); //remove arquivo de análise do status da câmera
		exit(-1);

	}
        system("sudo rm camanalyser.txt"); //remove arquivo de análise do status da câmera
	system("raspistill -vf -hf -o cam2.jpg"); //gira a foto
	system("raspistill -o cam.jpg");  //tira foto padrao

} //fotos


void ctrl_c(int sig)
{
     system("sudo pkill uv4l"); // remove file video%d
     //system("sudo rm stream.txt"); // remove file video%d
     printf("Cancelando os processos\n");
     //sudo pkill uv4l
     //system("rm stream.txt");
     exit(-1);
}

int main(int argc, char *argv[])
{

	setup();  	//definindo as portas wiringpi
    	pthread_t thr_1, thr_2;
    	signal(SIGINT, ctrl_c);
    	//signal(SIGUSR1, mensagem); para mandar futuramente sinal para segundo processo que vai mandar a foto por email ou telegram

	while(1)
	{
		usleep(50000);
		pthread_create(&thr_1, NULL, &ultr1, NULL);
		pthread_create(&thr_2, NULL, &ultr2, NULL);
			
		if((dist1 > 1 && dist1 < 5) | (dist2 > 1 && dist2 < 5))
		{
			usleep(50000);
			picture();  //tira a foto

		}
	}
    return 0;
}
